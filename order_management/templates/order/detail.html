{% extends 'order/base.html' %}

{% block style %}
    <style>

    .table_div{
        border:solid purple; border-width:1px 0px 0px 1px; overflow: hidden;
    }
    .td_div{
        border:solid purple;
        border-width:0px 1px 1px 0px;
        padding:5px 5px;
        margin-left:0px;
        float:left;
        height:30px;
        overflow:hidden;
    }
    </style>

{% endblock %}

{% block content %}
    <div class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header" data-background-color="purple">
                            <h4 class="title" style="display: inline-block;">Order List</h4>
                            <li class="active" style="display: inline-block; float:right; margin-right: 20px">
                                <a id="advanced_filter_collapse_btn">
                                    <i class="material-icons">zoom_in</i>
                                    高级筛选
                                    <div class="ripple-container"></div></a>
                                <a href="/order_add">
                                    <i class="material-icons">note_add</i>
                                    添加
                                    <div class="ripple-container"></div></a>
                            </li>
                        </div>
                        <div class="card-content">
                            <div style = "overflow:hidden;">
                                <div style="width:30%; display:inline">单号：<span id = "order_No"></span></div>
                                <div style="width:30%; display:inline">状态：<span id = "order_status"></span></div>
                            </div>

                            <div class="table_div">

                                <div class="td_div" style="width:10%">托运日期</div>
                                <div class="td_div" style="width:40%">{{ create_time }}</div>
                                <div class="td_div" style="width:10%">运行区间</div>
                                <div class="td_div" style="width:40%">{{ dep_city }} -> {{ des_city }}</div>
                                <div class="td_div" style="width:10%">托运人</div>
                                <div class="td_div" style="width:40%">{{ client_name }}</div>
                                <div class="td_div" style="width:10%">联系方式</div>
                                <div class="td_div" style="width:40%">{{ client_tel }}</div>
                                <div class="td_div" style="width:10%">收货人</div>
                                <div class="td_div" style="width:40%">{{ rec_name }}</div>
                                <div class="td_div" style="width:10%">联系方式</div>
                                <div class="td_div" style="width:40%">{{ rec_tel }}</div>

                                <div class="td_div" style="width:10%">起运地址</div>
                                <div class="td_div" style="width:90%">{{ dep_place }}</div>
                                <div class="td_div" style="width:10%">目的地址</div>
                                <div class="td_div" style="width:90%">{{ des_place }}</div>
                                <div class="td_div" style="width:10%">货物名称</div>
                                <div class="td_div" style="width:30%">{{ cargo_name }}</div>
                                <div class="td_div" style="width:10%">货物重量</div>
                                <div class="td_div" style="width:20%">{{ cargo_weight }}</div>
                                <div class="td_div" style="width:10%">货物数量</div>
                                <div class="td_div" style="width:20%">{{ cargo_quantity }}</div>
                                <div class="td_div" style="width:10%">备注</div>
                                <div class="td_div" style="width:90%">{{ note }}</div>
                                <div class="td_div" style="width:100%;height:auto">
                                    <a id="add_log_info" ><i class="material-icons">zoom_in</i>添加</a>
                                </div>
                                <div class="td_div" style="width:10%">状态</div>
                                <div class="td_div" style="width:25%">时间</div>
                                <div class="td_div" style="width:55%">描述</div>
                                <div class="td_div" style="width:10%">操作</div>
                                <div id = "log_info">


                                </div>
                                <div class="td_div" style="width:30%;word-wrap:break-word; height:auto">
                                    <p>
                                        asdfasdfa<br>sdfhuiasdhfi<br>u<br>cgb<br>dfa<br>gdgdafgrgeargergeargergerger
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block jscode %}
    <script>


        $(function(){
            show_status("{{ status }}");    //加载页面的时候填入状态
            $("#add_log_info").click(function(){
                $("#log_info").append('<div class="td_div edit_status" style="width:10%"></div>' +
                                      '<div class="td_div" style="width:25%">'+ (new Date().Format("yyyy-MM-dd hh:mm:ss"))+'</div>' +
                                      '<div class="td_div edit_desc" style="width:55%"></div>' +
                                      '<div class="td_div" style="width:10%">' +
                                      '<a href="#" class="log_confirm_btn" data-id={{ id }}><span class="glyphicon glyphicon-ok"></span></a>'+
                                      '<a href="#" class="log_cancel_btn"><span class="glyphicon glyphicon-remove"></span></a>'+
                                      '</div>');
                $(".edit_status").editable({
                    type: "select",
                    placement: "right",
                    emptytext: "---",
                    source: [{ value: "提货", text: "提货" }, { value: "出发", text: "出发" }, {value:"途径",text:"途径"}
                    , {value:"到达",text:"到达"}, {value:"签收",text:"签收"}, {value:"异常",text:"异常"}],
                });
                $(".edit_desc").editable({
                    emptytext: "---",
                });
            });
            $('body').on('click', '.log_confirm_btn', function(){
                var id     = $(this).data('id');
                var status = $(this).parent().prev().prev().prev().html();
                var time   = (new Date().Format("yyyy-MM-dd hh:mm:ss"));
                var desc   = $(this).parent().prev().html();
                var $thisdom = $(this).parent();
                if(status == "---"){
                    toastr.error("必须选择状态");
                    return;
                }
                $.ajax({
                    type: "POST",
                    url: "{% url 'ope_add_trace' %}",
                    data: {id:id, status:status, time:time, desc:desc},
                    datatype: "html",
                    success: function (data) {
                        if(data.success == 1){
                            toastr.success(data.info);
                            show_status(data.order_status);
                            $thisdom.html('<a href="#" class="log_edit_btn" data-trace_id="'+id+'"><span class="glyphicon glyphicon-edit"></span></a>');    //这里页面js会抛错，暂时未修复
                            $thisdom.prev().editable("destroy");
                            $thisdom.prev().removeClass("edit_desc")
                            $thisdom.prev().prev().prev().editable("destroy");
                            $thisdom.prev().prev().prev().removeClass("edit_status")
                        }
                        else{
                            toastr.error(data.info);
                        }


                    },
                });
            });

            $('body').on('click', '.log_cancel_btn', function(){

                $(this).parent().prev().prev().prev().remove();
                $(this).parent().prev().prev().remove();
                $(this).parent().prev().remove();
                $(this).parent().remove();

            });

            $('body').on('click', '.log_edit_btn', function(){
                var trace_id     = $(this).data('trace_id');
                var $this = $(this).parent().prev();
                $this.editable({
                    emptytext: "---",
                    success: function (response, newValue) {
                        $.ajax({
                            type: "POST",
                            url: "{% url 'ope_edit_trace' %}",
                            data: {trace_id:trace_id, desc:newValue},
                            datatype: "html",
                            success: function (data) {
                                toastr.success("修改成功")
                                $this.editable("destroy");
                            },
                        });
                    }
                });

            });

            $.ajax({
                    type: "POST",
                    url: "{% url 'get_trace_data' %}",
                    data: {id:"{{ id }}"},
                    datatype: "html",
                    success: function (data) {
                        console.log(data);
                        var rows = data.rows;
                        for (index in rows){
                            $("#log_info").append('<div class="td_div" style="width:10%">'+ rows[index].status +'</div>' +
                                                  '<div class="td_div" style="width:25%">'+ rows[index].time +'</div>' +
                                                  '<div class="td_div" style="width:55%">'+ rows[index].desc +'</div>' +
                                                  '<div class="td_div" style="width:10%">' +
                                                  '<a href="#" class="log_edit_btn" data-trace_id="'+rows[index].trace_id+'"><span class="glyphicon glyphicon-edit"></span></a>'+
                                                  '</div>');
                            $(".edit_status").editable({
                                type: "select",
                                placement: "right",
                                emptytext: "---",
                                source: [{ value: "提货", text: "提货" }, { value: "出发", text: "出发" }, {value:"途径",text:"途径"}
                                , {value:"到达",text:"到达"}, {value:"签收",text:"签收"}, {value:"异常",text:"异常"}],
                            });
                            $(".edit_desc").editable({
                                emptytext: "---",
                            });
                        }

                    },
            });

            //从view参数里加载状态到模板里
            function show_status(status){
                status = parseInt(status);
                var str = "";
                if(status==1)
                    str = "未发货";
                else if(status==2)
                    str = "已提货";
                else if(status==3)
                    str = "在途中";
                else if(status==4)
                    str = "已签收";
                else if(status==5)
                    str = "已出票";
                else if(status==6)
                    str = "已收款";
                else
                    return;
                $("#order_status").html(str);
            }

        });
    </script>
{% endblock %}